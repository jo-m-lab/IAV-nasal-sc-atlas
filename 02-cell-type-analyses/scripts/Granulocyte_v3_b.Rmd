---
title: "Granulocyte_v3"
output: html_document
---

## Set Up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/analysis/Output_v3/cb/dedub trim1/granulocyte/")
```

packages
```{r}
library(tidyverse)
library(Seurat)
library(openxlsx)
library(reticulate)
library(cowplot)
library(sctransform)
library(dplyr)
library(future)
theme_set(theme_cowplot())
plan("multicore", workers = 60)
options(future.globals.maxSize = 2048 * 1024^2) #set options for parallelization

sample.names = c("D14_OE","D14_RE","D14_LNG","D02_OE","D02_RE","D02_LNG","D05_OE","D05_RE","D05_LNG","D08_OE","D08_RE","D08_LNG","Naive_OE","Naive_RE","Naive_LNG")
source("~/analysis/scripts/plotting_functions_v2.R")
```

### Palettes
Palettes
```{r}
# cell.type.palette = c("#cb9b92","#c15336","#cdbc52","#546439","#79ce5e","#82c7b7","#8089c0","#8447c0","#4d2f46","#c85191")
# names(cell.type.palette) = levels(cb.dedub.t2$cell.type)

sample.palette = c("#97F797","#24EA24","#00B700","#007200","#133501",
                   "#C39DEA","#A05CF7","#7E2CFF","#5413BA","#2C0072",
                   "#FFEC64","#F9B903","#F48500","#F24400","#873000")
names(sample.palette) = c("Naive_RE","D02_RE","D05_RE","D08_RE","D14_RE",
                          "Naive_OE","D02_OE","D05_OE","D08_OE","D14_OE",
                          "Naive_LNG","D02_LNG","D05_LNG","D08_LNG","D14_LNG")
```

### Load in Object
```{r}
load("~/analysis/Output_v3/cb/cbdedubt2.1_processed.RData")
```


# granulocyte Round 1
Subset
```{r}
cb.dedub.t2.1 = SetIdent(cb.dedub.t2.1, value = "cell.type2")
cb.gran = subset(cb.dedub.t2.1, idents = "Granulocyte")
cb.gran = subset(cb.gran, features = c(rownames(cb.gran)[which(rowSums(cb.gran@assays$SCT@counts > 0) >= 10)], 
                               rownames(cb.gran[["HTO"]])))
cb.gran
```

Reprocess
```{r}
cb.gran = SCTransform(cb.gran, verbose = TRUE, method = "glmGamPoi")
cb.gran = RunPCA(cb.gran, verbose = TRUE)
DimPlot(cb.gran, dims = c(1,2), pt.size = 0.1, reduction = "pca", group.by = "orig.ident")
ElbowPlot(cb.gran, ndims = 50)
```

Clustering and Embedding
```{r}
cb.gran = FindNeighbors(cb.gran, dims = 1:30, k.param = 30, force.recalc = TRUE)
cb.gran = FindClusters(cb.gran, resolution = 0.4)
cb.gran = FindClusters(cb.gran, resolution = 0.6)
#cb.gran = FindClusters(cb.gran, resolution = 0.8)
cb.gran = RunUMAP(cb.gran, dims = 1:30, n.neighbors = 30)
```

Plot UMAP
```{r}
DimPlot(cb.gran, pt.size = 0.1, group.by = "SCT_snn_res.0.4", label = TRUE) + NoLegend()
DimPlot(cb.gran, pt.size = 0.1, group.by = "SCT_snn_res.0.6", label = TRUE) + NoLegend()
#DimPlot(cb.gran, pt.size = 0.1, group.by = "SCT_snn_res.0.8", label = TRUE) + NoLegend()
DimPlot(cb.gran, pt.size = 0.1, group.by = "orig.ident", shuffle = TRUE)
DimPlot(cb.gran, pt.size = 0.1, group.by = "region", shuffle = TRUE)
```

Find Markers
```{r}
cb.gran = SetIdent(cb.gran, value = "SCT_snn_res.0.4")
gran.all.res04.markers = FindAllMarkers(cb.gran, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.all.res04.markers, "gran_r1_res04_markers.xlsx") #r1 = round 1

cb.gran = SetIdent(cb.gran, value = "SCT_snn_res.0.6")
gran.all.res06.markers = FindAllMarkers(cb.gran, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.all.res06.markers, "gran_r1_res06_markers.xlsx") #r1 = round 1
```

Vlns/FeaturePlots for contaminating markers
```{r}
#FeaturePlot(cb.gran, c("Omp","Epcam",""), raster = TRUE, order = TRUE)
VlnPlot(cb.gran, c("Omp","Epcam","Col3a1","Obp1a","Ptprc"), pt.size = -1, stack = TRUE)
```
Cluster 4, 5 have OMP/Epcam
Cluster 7 has Obp [leave in for now]
Cluster 8 is macrophage doublets
Cluster 11, 13 is epithelial doublets
Cluster 12 is T cell doublets

** Using res = 0.4 **

save data
```{r}
save(cb.gran, file = "cbdedub2_gran.RData")
load("cbdedub2_gran.RData")
```

# granulocyte Round 2
Remove clusters 4, 5, 7, 8, 11-13
```{r}
good.gran.r1 = c(0:3,6,9,10)
#load("cbdedub2_gran.RData")
cb.gran = SetIdent(cb.gran, value = "SCT_snn_res.0.4")
cb.gran.r2 = subset(cb.gran, subset = SCT_snn_res.0.4 %in% good.gran.r1)
cb.gran.r2 = subset(cb.gran.r2, features = c(rownames(cb.gran.r2)[which(rowSums(cb.gran.r2@assays$SCT@counts > 0) >= 10)], 
                               rownames(cb.gran.r2[["HTO"]])))
cb.gran.r2
```

Reprocess
```{r}
cb.gran.r2 = SCTransform(cb.gran.r2, verbose = TRUE, method = "glmGamPoi")
cb.gran.r2 = RunPCA(cb.gran.r2, verbose = TRUE)
DimPlot(cb.gran.r2, dims = c(1,2), pt.size = 0.1, reduction = "pca", group.by = "orig.ident")
ElbowPlot(cb.gran.r2, ndims = 50)
```

Clustering and Embedding
```{r}
cb.gran.r2 = FindNeighbors(cb.gran.r2, dims = 1:15, k.param = 30, force.recalc = TRUE)
cb.gran.r2 = FindClusters(cb.gran.r2, resolution = 0.4)
cb.gran.r2 = FindClusters(cb.gran.r2, resolution = 0.6)
cb.gran.r2 = RunUMAP(cb.gran.r2, dims = 1:15, n.neighbors = 30)
```

Plot UMAP
```{r}
DimPlot(cb.gran.r2, pt.size = 0.1, group.by = "SCT_snn_res.0.4", label = TRUE) + NoLegend()
DimPlot(cb.gran.r2, pt.size = 0.1, group.by = "SCT_snn_res.0.6", label = TRUE) + NoLegend()
DimPlot(cb.gran.r2, pt.size = 0.1, group.by = "orig.ident", shuffle = TRUE)
DimPlot(cb.gran.r2, pt.size = 0.1, group.by = "region", shuffle = TRUE)
```

Find Markers
```{r}
cb.gran.r2 = SetIdent(cb.gran.r2, value = "SCT_snn_res.0.4")
gran.r2.all.markers.res04 = FindAllMarkers(cb.gran.r2, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.r2.all.markers.res04, "gran_r2_res04_markers.xlsx", overwrite = TRUE)

cb.gran.r2 = SetIdent(cb.gran.r2, value = "SCT_snn_res.0.6")
gran.r2.all.markers.res06 = FindAllMarkers(cb.gran.r2, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.r2.all.markers.res06, "gran_r2_res06_markers.xlsx", overwrite = TRUE)
```

Cluster 5, 8 are a mix of OBP and hi-mito cells
** Choosing res = 0.4**

Specific comparisons
```{r}
cb.gran.r2 = SetIdent(cb.gran.r2, value = "SCT_snn_res.0.4")
```

VlnPlots
```{r}
VlnPlot(cb.gran.r2, c("Omp","Ly6g"), pt.size = -1, stack = TRUE) + NoLegend()
```

save data
```{r}
save(cb.gran.r2, file = "cbdedub2_gran_r2.RData")
load("cbdedub2_gran_r2.RData")
```


# granulocyte Round 3
Remove doublet clusters 5 & 8 (using res=0.4)
```{r}
good.gran.r2 = c(0:4,6,7,9,10)
#load("cbdedub2_gran_r2.RData")
cb.gran.r3 = subset(cb.gran.r2, subset = SCT_snn_res.0.4 %in% good.gran.r2)
cb.gran.r3 = subset(cb.gran.r3, features = c(rownames(cb.gran.r3)[which(rowSums(cb.gran.r3@assays$SCT@counts > 0) >= 10)], 
                               rownames(cb.gran.r3[["HTO"]])))
cb.gran.r3
```

Reprocess
```{r}
cb.gran.r3 = SCTransform(cb.gran.r3, verbose = TRUE, method = "glmGamPoi")
cb.gran.r3 = RunPCA(cb.gran.r3, verbose = TRUE)
DimPlot(cb.gran.r3, dims = c(1,2), pt.size = 0.1, reduction = "pca", group.by = "orig.ident")
ElbowPlot(cb.gran.r3, ndims = 50)
```

Clustering and Embedding
```{r}
cb.gran.r3 = FindNeighbors(cb.gran.r3, dims = 1:15, k.param = 30)
cb.gran.r3 = FindClusters(cb.gran.r3, resolution = 0.3)
cb.gran.r3 = FindClusters(cb.gran.r3, resolution = 0.4)
cb.gran.r3 = FindClusters(cb.gran.r3, resolution = 0.5)
cb.gran.r3 = RunUMAP(cb.gran.r3, dims = 1:15, n.neighbors = 30)
```

Plot UMAP
```{r}
DimPlot(cb.gran.r3, pt.size = 0.1, group.by = "SCT_snn_res.0.3", label = TRUE) + NoLegend()
DimPlot(cb.gran.r3, pt.size = 0.1, group.by = "SCT_snn_res.0.4", label = TRUE) + NoLegend()
DimPlot(cb.gran.r3, pt.size = 0.1, group.by = "SCT_snn_res.0.5", label = TRUE) + NoLegend()
DimPlot(cb.gran.r3, pt.size = 0.1, group.by = "orig.ident", shuffle = TRUE)
DimPlot(cb.gran.r3, pt.size = 0.1, group.by = "region", shuffle = TRUE)
```

Find Markers
```{r}
cb.gran.r3 = SetIdent(cb.gran.r3, value = "SCT_snn_res.0.3")
gran.r3.all.markers.res03 = FindAllMarkers(cb.gran.r3, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.r3.all.markers.res03, "gran_r3_res03_markers.xlsx", overwrite = TRUE)

cb.gran.r3 = SetIdent(cb.gran.r3, value = "SCT_snn_res.0.4")
gran.r3.all.markers.res04 = FindAllMarkers(cb.gran.r3, logfc.threshold = 0.5, min.pct = 0.2, only.pos = TRUE)
write.xlsx(gran.r3.all.markers.res04, "gran_r3_res04_markers.xlsx", overwrite = TRUE)
```

Specific comparisons
```{r}
cb.gran.r3 = SetIdent(cb.gran.r3, value = "SCT_snn_res.0.4")
gran.0v3 = FindMarkers(cb.gran.r3, ident.1 = 0, ident.2 = 3, logfc.threshold = 0.5, min.pct = 0.2) 
gran.2v7 = FindMarkers(cb.gran.r3, ident.1 = 2, ident.2 = 7, logfc.threshold = 0.5, min.pct = 0.2) 
gran.4v5 = FindMarkers(cb.gran.r3, ident.1 = 4, ident.2 = 5, logfc.threshold = 0.5, min.pct = 0.2) 
```

VlnPlots
```{r}
VlnPlot(cb.gran.r3, c("Siglecf","Adamdec1","Itgax","Il1b","Ccl6","H2-D1","Camp"), pt.size = -1, stack = TRUE) + NoLegend()
```

** USING res = 0.4 **

Assign names from excel sheet
```{r}
gran.r3.short.names = c("Dusp2+Icam1+ Mature","Retnlg+Ccl6+ Immature","MHC-I Hi Mature","Jaml+Adamdec1+ Mature","Camp++Lta4h+ Immature","Camp+Il1b+ Immature","Cycling Immature","IFN-Stim Mature","Mast Cell","Progenitor")
gran.r3.short.names.order = c(9,6,4,5,1,2,7,0,3,8)+1
gran.r3.palette = c("#ddc349","#be8b4c","#d75033","#7f392b","#ca5678","#ce4dbb","#5e3c7d","#ae8cd2","#6f49c9","forestgreen")
names(gran.r3.palette) = gran.r3.short.names[gran.r3.short.names.order]
```
```{r}
cb.gran.r3$r3.short.names = plyr::mapvalues(cb.gran.r3$SCT_snn_res.0.4, from = 0:9, to = gran.r3.short.names)
cb.gran.r3$r3.short.names = factor(cb.gran.r3$r3.short.names, levels = gran.r3.short.names[gran.r3.short.names.order])
```


save data
```{r}
save(cb.gran.r3, file = "~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
load("~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
```


Sample by cluster
```{r}
gran.r3.cluster.by.sample = cb.gran.r3@meta.data %>% group_by(r3.short.names,orig.ident) %>% 
  summarise(count = n()) %>% mutate(freq = count/sum(count))
gran.r3.cluster.by.sample$orig.ident = factor(gran.r3.cluster.by.sample$orig.ident, levels = names(sample.palette))

ggplot(gran.r3.cluster.by.sample, aes(x=r3.short.names, y=freq*100, fill=orig.ident)) + geom_bar(stat="identity") +
  scale_fill_manual(values = sample.palette) + 
  theme(axis.text.x = element_text(angle=45, vjust = 1, hjust = 1)) + labs(x="", y="Proportion of Cluster (%)")
ggsave("gran_r3_sample_by_cluster.pdf", height = 5, width = 5)
```


Replot umap with new names
```{r}
DimPlot(cb.gran.r3, pt.size = 0.3, group.by = "r3.short.names", label = TRUE, cols = gran.r3.palette) + NoLegend()
ggsave("gran_r3_named_UMAP.pdf", height = 7, width = 7)
```

Frequency Analysis by cluster and sample
```{r}
cb.gran.r3$Short.Name = cb.gran.r3$r3.short.names #required for our plotting mechanic
cb.gran.r3$orig.ident = factor(cb.gran.r3$orig.ident, levels = names(sample.palette))

gran.r3.cluster.RT.freq.by.hash = CalcFreqByHash(srobj = cb.gran.r3, tissue = "RT", which.names = "Short",
                                                plot.height = 8, plot.width = 10, plot.ncol = 5, #plot.ylim.max = 45, 
                                                filename = "gran_r3_RT_freq_by_Hash_old.pdf")
gran.r3.cluster.ET.freq.by.hash = CalcFreqByHash(srobj = cb.gran.r3, tissue = "ET", 
                                                plot.height = 8, plot.width = 10, plot.ncol = 5, #plot.ylim.max = 50, 
                                                filename = "gran_r3_ET_freq_by_Hash_old.pdf")
gran.r3.cluster.Sinus.freq.by.hash = CalcFreqByHash(srobj = cb.gran.r3, tissue = "Sinus", 
                                                plot.height = 8, plot.width = 10, plot.ncol = 5, #plot.ylim.max = 30, 
                                                filename = "gran_r3_Sinus_freq_by_Hash.pdf")
```

Stats on frequencies
```{r}
gran.r3.cluster.RT.freq.by.hash = gran.r3.cluster.RT.freq.by.hash[-which(gran.r3.cluster.RT.freq.by.hash$assignment == ""),]
write.table(gran.r3.cluster.RT.freq.by.hash, file = "~/analysis/Output_v3/cb/dedub trim1/granulocyte/Gran_RT_Freq_table.txt", sep = "\t", quote = FALSE, row.names = FALSE)
gran.r3.cluster.ET.freq.by.hash = gran.r3.cluster.ET.freq.by.hash[-which(gran.r3.cluster.ET.freq.by.hash$assignment == ""),]
write.table(gran.r3.cluster.ET.freq.by.hash, file = "~/analysis/Output_v3/cb/dedub trim1/granulocyte/Gran_ET_Freq_table.txt", sep = "\t", quote = FALSE, row.names = FALSE)
```

Flu transcripts
```{r}
VlnPlot(cb.gran.r3, features = c("PR8.SCT.total"), group.by = "r3.short.names", pt.size = 0.1, raster = TRUE) + NoLegend()
ggsave("gran_r3_PR8_count_vln.pdf", height = 5, width = 6)
```

<!-- Flu positivity (just based on transcript count) -->
<!-- ```{r} -->
<!-- cb.gran.r3$flu.status = "neg"; cb.gran.r3$flu.status[cb.gran.r3$PR8.SCT.total > 0] = "pos" -->
<!-- granv3.flu.counts.by.sample = cb.gran.r3@meta.data %>% group_by(orig.ident, assignment, flu.status) %>% summarise(count = n()) -->

<!-- granv3.flu.RT.assignment = granv3.flu.counts.by.sample[intersect(intersect(which(granv3.flu.counts.by.sample$flu.status == "pos"), -->
<!--                                                       grep("RT|",granv3.flu.counts.by.sample$assignment)), -->
<!--                                                       grep("RE",granv3.flu.counts.by.sample$orig.ident)),] -->
<!-- granv3.flu.RT.assignment = rbind(data.frame(orig.ident=rep("Naive_RE",5), -->
<!--                                            assignment=rep("",5), -->
<!--                                            flu.status=rep("pos",5), -->
<!--                                            count=rep(0,5)), -->
<!--                                 granv3.flu.RT.assignment,) -->
<!-- granv3.flu.RT.assignment$orig.ident = factor(granv3.flu.RT.assignment$orig.ident, levels = names(sample.palette)) -->

<!-- ggplot(granv3.flu.RT.assignment, aes(x=orig.ident, y=count, color=orig.ident)) + geom_point(size = 2.5) + scale_color_manual(values = sample.palette) + labs(x = "Time Point", y = "# of Cells with PR8 RNA") + guides(color = "none") -->
<!-- ggsave("trim1/gran/v3/granv3_flu_positive_cells_Hash.pdf", height = 4, width = 3) -->
<!-- ``` -->

Big Violin Plot of Cluster Defining Genes
```{r}
cb.gran.r3 = SetIdent(cb.gran.r3, value = "r3.short.names")

granv3.cluster.genes = c("Lyz2","Ly6g","Elane","Mpo","Ifitm6","Camp","Mki67","Top2a","Ltf","Lta4h","Mmp8","Il1b","Retnlg","Ccl6","Csf3r","H2-D1","Clec4d","Isg15","Ifit3","Siglecf","Itgax","Dusp2","Icam1","Jaml","Adamdec1","Il6","Gata2","Il4")

VlnPlot(cb.gran.r3, features = granv3.cluster.genes, pt.size = -1, cols = gran.r3.palette, stack = TRUE, fill.by = "ident") + NoLegend()
ggsave("gran_r3_cluster_markers_violin.pdf", height = 4.5, width = 10)
```


<!-- save again -->
<!-- ```{r} -->
<!-- save(cb.gran.r3, file = "trim1/epi/v3/cb_dedub_trim1_epi_v3.RData") -->
<!-- load("trim1/epi/v3/cb_dedub_trim1_epi_v3.RData") -->
<!-- ``` -->

<!-- write out frequency tables -->
<!-- ```{r} -->
<!-- write.xlsx(epiv3.cluster.RT.freq.by.hash,  -->
<!--            file = "trim1/epi/v3/epiv3_freq_tables_by_region.xlsx") -->
<!-- ``` -->

Other outputs
```{r}
require(SeuratDisk)
load("~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
saveRDS(cb.gran.r3@meta.data, "~/analysis/Output_v3/r3_metadata/gran_r3_metadata.RDS")

#convert raw counts into a scanpy file for cnmf
cb.gran.r3.raw = CreateSeuratObject(counts = cb.gran.r3@assays$RNA@counts)
SaveH5Seurat(cb.gran.r3.raw, filename = "~/analysis/Output_v3/counts_for_cnmf/gran_r3.h5Seurat", overwrite = TRUE)
Convert("~/analysis/Output_v3/counts_for_cnmf/gran_r3.h5Seurat", dest = "h5ad", overwrite = TRUE)
```

## New vector for cluster names for data combining
```{r}
load("~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
```

```{r}
gran.r3.short.names = c("Dusp2+Icam1+ Mature","Retnlg+Ccl6+ Immature","MHC-I Hi Mature","Jaml+Adamdec1+ Mature","Camp++Lta4h+ Immature","Camp+Il1b+ Immature","Cycling Immature","IFN-Stim Mature","Mast Cell","Progenitor")
gran.r3.unique.names = c("Dusp2+Icam1+ Mature Neu","Retnlg+Ccl6+ Immature Neu","MHC-I Hi Mature Neu","Jaml+Adamdec1+ Mature Neu","Camp++Lta4h+ Immature Neu","Camp+Il1b+ Immature Neu","Cycling Immature Neu","IFN-Stim Mature Neu","Mast Cell","Granulo Progenitor")
cb.gran.r3$r3.unique.names = plyr::mapvalues(cb.gran.r3$r3.short.names, from = gran.r3.short.names, to = gran.r3.unique.names)
```

```{r}
save(cb.gran.r3, file = "~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
saveRDS(cb.gran.r3@meta.data, "~/analysis/Output_v3/r3_metadata/gran_r3_metadata.RDS")
```


# Revisions Analysis
## Check the stacked bar charts and frequency plots for inconsistencies
```{r}
gran.r3.cluster.by.sample = cb.gran.r3@meta.data %>% group_by(r3.unique.names,orig.ident) %>% 
  summarise(count = n()) %>% mutate(freq = count/sum(count))
gran.r3.cluster.by.sample$orig.ident = factor(gran.r3.cluster.by.sample$orig.ident, levels = names(sample.palette))

ggplot(gran.r3.cluster.by.sample, aes(x=r3.unique.names, y=freq*100, fill=orig.ident)) + geom_bar(stat="identity") +
  scale_fill_manual(values = sample.palette) + 
  theme(axis.text.x = element_text(angle=45, vjust = 1, hjust = 1)) + labs(x="", y="Proportion of Cluster (%)")
#ggsave("gran_r3_sample_by_cluster.pdf", height = 5, width = 5)

gran.r3.sample.by.cluster = cb.gran.r3@meta.data %>% group_by(orig.ident,r3.unique.names) %>% 
  summarise(count = n()) %>% mutate(freq = count/sum(count))
gran.r3.cluster.by.sample$orig.ident = factor(gran.r3.cluster.by.sample$orig.ident, levels = names(sample.palette))

ggplot(gran.r3.cluster.by.sample, aes(x=r3.unique.names, y=freq*100, fill=orig.ident)) + geom_bar(stat="identity") +
  scale_fill_manual(values = sample.palette) + 
  theme(axis.text.x = element_text(angle=45, vjust = 1, hjust = 1)) + labs(x="", y="Proportion of Cluster (%)")
```

Are the cell numbers just much lower for granulocytes in OM at 5 dpi?
```{r}
assignment = droplevels(cb.gran.r3@meta.data$assignment)
table(assignment)
```
The answer is yes, only 33/37/49 cells per mouse for D5 OM compared to hundreds for other time points
Let's plot the cell numbers per timepoint for OM
```{r}
assignment.table = as.data.frame(table(assignment))[-1,]
assignment.table$tissue = rep(c(rep("OM",3),rep("RM",3),rep("LNG",3)),5)
assignment.table$timepoint = c(rep("14 dpi",9),rep("8 dpi",9),rep("5 dpi",9),rep("2 dpi",9),rep("Naive",9))
assignment.table$timepoint = factor(assignment.table$timepoint, levels = c("Naive","2 dpi","5 dpi","8 dpi","14 dpi"))
assignment.table.OM = subset(assignment.table, tissue == "OM")

ggplot(assignment.table.OM, aes(x = timepoint, y = Freq, color = timepoint)) + geom_jitter(size = 2, height = 0, width = 0.1) + scale_color_manual(values = as.character(sample.palette[6:10])) + labs(x = "", y = "OM Granulocyte Cell Count", color = "Time Point") + ylim(c(0,675)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("~/analysis/Revision_Plots/Gran_OM_Counts.pdf", height = 3, width = 4)
```

## Plot neutrophil state genes
We'll use genes from Xie 2020 Nat Immunol
```{r}
xie.genes = scan("~/analysis/gene_lists/Xie_gene_list.txt", what=character())
xie.genes[8] = "Cstdc4"
cb.gran.r3 = SetIdent(cb.gran.r3, value = "r3.short.names")
cb.gran.r3.only = subset(cb.gran.r3, subset = r3.short.names != "Mast Cell")
DotPlot(cb.gran.r3.only, features = rev(xie.genes), dot.scale = 5, scale = TRUE) + theme(axis.text.x = element_text(angle = 55, hjust = 1))
ggsave("~/analysis/Revision_Plots/neutro_Xie_genes_dotplot.pdf", height = 3.75, width = 9.5)
```


# Plots for others
## For Rodrigo
```{r}
load("~/analysis/Output_v3/Seurat_objects/cbdedub2_gran_r3.RData")
```

FeaturePlots
```{r}
FeaturePlot(cb.gran.r3, features = c("Ly6g","Itgam","Itgax","Siglecf"), order = TRUE, pt.size = 0.05) & NoLegend() & NoAxes()
ggsave("featureplots_neutrophils.png", height = 6, width = 6)
```

```{r}
cb.gran.r3 = SetIdent(cb.gran.r3, value = "r3.short.names")
FeaturePlot(cb.gran.r3, features = c("H2"), order = TRUE, pt.size = 0.05) & NoLegend() & NoAxes()
VlnPlot(cb.gran.r3, features = c("H2-T23"), pt.size = -1) + NoLegend
```

```{r}
VlnPlot(cb.gran.r3, features = sort(grep("H2-", rownames(cb.gran.r3), value=TRUE)), pt.size = -1, stack = TRUE) + NoLegend()
```

## Picking out flow markers
```{r}
VlnPlot(cb.gran.r3, features = c("Cxcr4"), pt.size = -1, cols = gran.r3.palette, stack = FALSE, fill.by = "ident") + NoLegend()
```